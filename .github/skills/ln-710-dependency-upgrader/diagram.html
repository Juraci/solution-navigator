<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-710-dependency-upgrader - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-710-dependency-upgrader</h1>
    <p>L2 Domain Coordinator - Upgrades all dependencies to latest versions</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> Detect: Start

    state Detect {
        [*] --> CheckNpm
        CheckNpm --> CheckNuget
        CheckNuget --> CheckPip
        CheckPip --> [*]
    }

    Detect --> Delegate: Stack Detected

    state Delegate {
        [*] --> npm_check
        npm_check --> nuget_check: If .csproj
        npm_check --> pip_check: If requirements.txt
        nuget_check --> pip_check
        pip_check --> [*]

        npm_check: ln-711 npm-upgrader
        nuget_check: ln-712 nuget-upgrader
        pip_check: ln-713 pip-upgrader
    }

    Delegate --> Verify: Upgrades Complete
    Verify --> Report: All Tests Pass
    Verify --> Rollback: Tests Fail

    Rollback --> AskUser
    AskUser --> Delegate: Retry with fixes
    AskUser --> Report: Continue with warnings

    Report --> [*]: Complete
    </div>

    <h2>Delegation Flow</h2>
    <div class="mermaid">
flowchart TD
    Start([ln-710 Coordinator]) --> DetectStack{Detect Package Managers}

    DetectStack --> HasNpm{package.json?}
    HasNpm -->|Yes| Npm[ln-711 npm-upgrader]
    HasNpm -->|No| HasNuget

    DetectStack --> HasNuget{*.csproj?}
    HasNuget -->|Yes| Nuget[ln-712 nuget-upgrader]
    HasNuget -->|No| HasPip

    DetectStack --> HasPip{requirements.txt?}
    HasPip -->|Yes| Pip[ln-713 pip-upgrader]
    HasPip -->|No| NoDeps[No Dependencies Found]

    Npm --> Verify[Verify Builds]
    Nuget --> Verify
    Pip --> Verify

    Verify --> Report([Generate Report])
    NoDeps --> Report

    classDef worker fill:#E6E6FA
    classDef coordinator fill:#90EE90
    class Npm,Nuget,Pip worker
    class Start coordinator
    </div>

    <h2>Breaking Change Handling</h2>
    <div class="mermaid">
sequenceDiagram
    participant C as Coordinator
    participant W as Worker
    participant MCP as Context7/Ref
    participant T as Test Runner

    C->>W: Upgrade Package
    W->>W: npm outdated / dotnet outdated

    alt Breaking Change Detected
        W->>MCP: Query Migration Guide
        MCP-->>W: Migration Steps
        W->>W: Apply Migration
    end

    W->>T: Run Tests
    T-->>W: Test Results

    alt Tests Pass
        W-->>C: Upgrade Success
    else Tests Fail
        W->>W: Rollback Version
        W-->>C: Upgrade Failed (with details)
    end
    </div>

    <footer>
        <p>ln-710-dependency-upgrader v1.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
