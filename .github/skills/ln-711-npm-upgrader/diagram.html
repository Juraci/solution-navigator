<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-711-npm-upgrader - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-711-npm-upgrader</h1>
    <p>L3 Worker - Upgrades npm/yarn/pnpm dependencies</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> Analyze: Start

    Analyze --> SecurityAudit: Dependencies Loaded
    SecurityAudit --> CheckOutdated: Audit Pass
    SecurityAudit --> Report: Critical CVE Found

    CheckOutdated --> IdentifyBreaking: Outdated Found
    CheckOutdated --> Report: All Up-to-date

    IdentifyBreaking --> ApplyUpgrades: Breaking Changes Mapped
    ApplyUpgrades --> ApplyMigrations: Packages Updated

    ApplyMigrations --> VerifyBuild: Migrations Applied
    VerifyBuild --> Report: Build Pass

    VerifyBuild --> Rollback: Build Fail
    Rollback --> ApplyUpgrades: Retry Next Package

    Report --> [*]: Complete
    </div>

    <h2>Package Manager Detection</h2>
    <div class="mermaid">
flowchart TD
    Start([Receive Context]) --> CheckLock{Check Lock File}

    CheckLock --> HasNpmLock{package-lock.json?}
    HasNpmLock -->|Yes| UseNpm[Use npm]
    HasNpmLock -->|No| HasYarnLock

    HasYarnLock{yarn.lock?}
    HasYarnLock -->|Yes| UseYarn[Use yarn]
    HasYarnLock -->|No| HasPnpmLock

    HasPnpmLock{pnpm-lock.yaml?}
    HasPnpmLock -->|Yes| UsePnpm[Use pnpm]
    HasPnpmLock -->|No| DefaultNpm[Default to npm]

    UseNpm --> Proceed([Continue Upgrade])
    UseYarn --> Proceed
    UsePnpm --> Proceed
    DefaultNpm --> Proceed

    classDef decision fill:#FFE4B5
    classDef action fill:#90EE90
    class HasNpmLock,HasYarnLock,HasPnpmLock decision
    class UseNpm,UseYarn,UsePnpm,DefaultNpm action
    </div>

    <h2>Upgrade Priority Order</h2>
    <div class="mermaid">
flowchart LR
    P1[1. Peer Deps] --> P2[2. Framework]
    P2 --> P3[3. Build Tools]
    P3 --> P4[4. UI Libraries]
    P4 --> P5[5. Utilities]
    P5 --> P6[6. Dev Deps]

    classDef high fill:#FF6B6B
    classDef medium fill:#FFE66D
    classDef low fill:#4ECDC4
    class P1,P2 high
    class P3,P4 medium
    class P5,P6 low
    </div>

    <h2>Peer Dependency Resolution</h2>
    <div class="mermaid">
sequenceDiagram
    participant W as Worker
    participant NPM as npm
    participant Ctx as Context7/Ref

    W->>NPM: npm install package@latest
    NPM-->>W: ERESOLVE Error

    W->>NPM: npm install --legacy-peer-deps
    NPM-->>W: Success or Fail

    alt Still Fails
        W->>Ctx: Query peer resolution
        Ctx-->>W: Resolution steps
        W->>NPM: Apply resolution
    end

    NPM-->>W: Final Result
    </div>

    <footer>
        <p>ln-711-npm-upgrader v1.1.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
